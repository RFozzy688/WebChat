<local:BasePage x:TypeArguments="local:ChatMessageListVM"
    x:Class="WebChatClient.ChatPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
    xmlns:local="clr-namespace:WebChatClient"
    mc:Ignorable="d"
    x:Name="Page"
      
    Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Window}}"
    Height="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=Window}}"
    d:DataContext="{x:Static local:ChatMessageListDesignModel.Instance}"><!---->

    <Grid>

        <Grid.RowDefinitions>

            <!-- Заголовок -->
            <RowDefinition Height="Auto" />

            <!-- Тень -->
            <RowDefinition Height="Auto" />

            <!-- Лист сообщений -->
            <RowDefinition Height="*" />

            <!-- Текстовое поле отправки сообщения -->
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Наложение всплывающего окна -->
        <Border Background="Transparent" 
                Grid.RowSpan="3"
                Panel.ZIndex="1"
                Visibility="{Binding AnyPopupVisible, 
                                     Converter={local:BooleanToVisiblityConverter}, 
                                     ConverterParameter=True}">

            <Border.InputBindings>
                <MouseBinding MouseAction="LeftClick" Command="{Binding PopupClickawayCommand}" />
            </Border.InputBindings>
        </Border>

        <!-- Заголовок -->
        <Grid Height="50" Background="{StaticResource LightBlueBrush}"
              Margin="0,0,2,0">

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />

            </Grid.ColumnDefinitions>

            <!-- Текст заголовка -->
            <TextBlock Text="{Binding DisplayTitle}" 
                       Grid.ColumnSpan="2"
                       Foreground="{StaticResource VeryLightBrush}"
                       FontSize="{StaticResource FontSizeXLarge}"
                       FontFamily="{StaticResource RoundedRegular}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       />

            <!-- Кнопки в заголовке -->
            <StackPanel Orientation="Horizontal" Grid.Column="1">
                <Button Style="{StaticResource IconButton}" 
                        Content="{StaticResource FA_SearchIcon}"
                        Command="{Binding OpenSearchCommand}"/>
                <Button Style="{StaticResource IconButton}" Content="{StaticResource FA_EllipsisVerticalIcon}" />
            </StackPanel>

            <!-- Строка поиска -->
            <Grid Grid.ColumnSpan="2"
                  local:AnimateSlideInFromRightMarginProperty.Value="{Binding SearchIsOpen}"
                  >

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Кнопка закрытия поиска -->
                <Button Style="{StaticResource IconButton}" 
                        Content="{StaticResource FA_CloseIcon}"
                        Command="{Binding CloseSearchCommand}"
                        Foreground="{StaticResource VeryLightBrush}"
                        Margin="0 2 2 2"
                        />

                <!-- Search box -->
                <TextBox 
                    Grid.Column="1" 
                    Tag="Поиск текста..."
                    local:FocusProperty.Value="{Binding SearchIsOpen}"
                    Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                    Margin="0 2 2 2"
                    FontSize="{StaticResource FontSizeRegular}"
                    BorderThickness="0"
                    >
                    <TextBox.InputBindings>
                        <!-- Clear text on Esc -->
                        <KeyBinding Command="{Binding ClearSearchCommand}" Key="Esc" />
                        <!-- Search on enter -->
                        <KeyBinding Command="{Binding SearchCommand}" Key="Return" />
                    </TextBox.InputBindings>
                </TextBox>


            </Grid>

        </Grid>

        <!-- Тень -->
        <Border Grid.Row="1" BorderThickness="0 0.2 0 0">
            <!-- Линия тени -->
            <Border.BorderBrush>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1, 0">
                    <GradientStop Color="{StaticResource MiddleDark}" Offset="0.0" />
                    <GradientStop Color="{StaticResource  VeryDark}" Offset="0.5" />
                    <GradientStop Color="{StaticResource MiddleDark}" Offset="1.0" />
                </LinearGradientBrush>
            </Border.BorderBrush>
        </Border>

        <!-- Лист сообщений -->
        <local:ChatMessageListControl Grid.Row="2"
                                      x:Name="ChatMessageList"
                                      DataContext="{Binding}"/>

        <!--всплывающее меню-->
        <Border Grid.Row="2"
                Panel.ZIndex="2"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Left"
                local:AnimateSlideInFromBottomProperty.Value="{Binding AttachmentMenuVisible}">

            <local:BubbleContent DataContext="{Binding AttachmentMenu}"/>
        </Border>

        <Border CornerRadius="0,0,10,0" Grid.Row="3" 
                Background="{StaticResource VeryLightBrush}"
                BorderBrush="{StaticResource MiddleDarkBrush}"
                BorderThickness="1,0,0,0"
                Panel.ZIndex="3">
            
            <!-- Текстовое поле отправки сообщения -->
            <Grid MinHeight="50"
                  MaxHeight="114">

                <Grid.ColumnDefinitions>
                    <!-- Кнопка прикрепить  -->
                    <ColumnDefinition Width="Auto" />

                    <!-- Поле ввода текста -->
                    <ColumnDefinition Width="*" />

                    <!-- Дополнительные кнопки -->
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- кнопка прикрепить -->
                <Button Style="{StaticResource IconGrowButton}"
                        Height="{Binding MinHeight, RelativeSource={RelativeSource AncestorType=Grid}}"
                        Content="{StaticResource FA_PaperclipIcon}"
                        Foreground="{StaticResource MiddleDarkBrush}"
                        Command="{Binding AttachmentButtonCommand}"/>

                <!-- Окно сообщения -->
                <TextBox x:Name="MessageText" 
                         Grid.Column="1" 
                         Tag="Написать сообщение..."
                         FontSize="{StaticResource FontSizeRegular}"
                         Text="{Binding PendingMessageText, UpdateSourceTrigger=PropertyChanged}"
                         local:IsFocusedProperty.Value="True"
                         VerticalAlignment="Center"
                         BorderThickness="0"
                         Padding="0 10"
                         AcceptsReturn="True"
                         AcceptsTab="True"
                         VerticalScrollBarVisibility="Auto"
                         Margin="10,0,0,0"
                         PreviewKeyDown="MessageText_PreviewKeyDown"/>

                <!-- Дополнительные кнопки -->
                <StackPanel Orientation="Horizontal"
                            VerticalAlignment="Top"
                            Margin="0 0 8 0"
                            Grid.Column="3">

                    <!-- Emoji кнопка -->
                    <Button Style="{StaticResource IconGrowButton}"
                            Height="{Binding MinHeight, RelativeSource={RelativeSource AncestorType=Grid}}"
                            Content="{StaticResource FA_EmojiIcon}"
                            Foreground="{StaticResource OrangeBrush}"/>

                    <!--Кнопка отправить -->
                    <Button Content="Отправить"
                            Padding="8"
                            IsDefault="True"
                            Focusable="False"
                            Command="{Binding SendCommand}"
                            Style="{StaticResource SendButton}"
                            FontSize="{StaticResource FontSizeRegular}"/>

                </StackPanel>

            </Grid>
        </Border>
    </Grid>

</local:BasePage>
